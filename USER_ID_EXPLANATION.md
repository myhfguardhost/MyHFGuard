# How Users Are Created and Get IDs

## Overview

Your app uses **two separate systems** that work together:

1. **Supabase Auth** - Handles user authentication (login/register)
2. **Patients Table** - Stores patient health data

## The User Creation Flow (Web App)

### Step 1: User Registers on Web App
When someone registers at `/register`, they provide:
- Email
- Password
- First Name
- Last Name
- Date of Birth

### Step 2: Supabase Auth Creates User
```javascript
// In Register.tsx (line 31-35)
const { data, error } = await supabase.auth.signUp({
  email,
  password,
  options: { 
    data: { 
      firstName: formData.firstName, 
      lastName: formData.lastName, 
      dateOfBirth: formData.dateOfBirth 
    } 
  },
})
```

**What happens:**
- Supabase Auth creates a new user account
- **Supabase automatically generates a UUID** (e.g., `a1b2c3d4-e5f6-7890-abcd-ef1234567890`)
- This UUID is stored in Supabase Auth as the **user ID**
- The user metadata (firstName, lastName, dateOfBirth) is stored in `user_metadata`

### Step 3: Create Patient Record
```javascript
// In Register.tsx (line 44-53)
const userId = data?.user?.id  // This is the UUID from Supabase Auth

await fetch(`${API}/admin/ensure-patient`, {
  method: "POST",
  body: JSON.stringify({
    patientId: userId,  // ← The Supabase Auth UUID becomes the patient_id
    firstName: formData.firstName,
    lastName: formData.lastName,
    dateOfBirth: formData.dateOfBirth,
  }),
})
```

**What happens:**
- The server calls `ensurePatient()` function
- Creates a record in the `patients` table:
  - `patient_id` = **the Supabase Auth UUID** (same as user ID)
  - `first_name` = firstName
  - `last_name` = lastName
  - `dob` = dateOfBirth

### Step 4: Set User Role
```javascript
// In Register.tsx (line 55-60)
await fetch(`${API}/admin/promote`, {
  method: "POST",
  body: JSON.stringify({ 
    id: userId, 
    role: "patient" 
  }),
})
```

**What happens:**
- Sets `app_metadata.role = "patient"` in Supabase Auth
- This allows the user to access patient routes

---

## The Key Relationship

```
Supabase Auth User ID = Patient ID (same UUID)
```

**Example:**
- User registers with email: `john@example.com`
- Supabase Auth creates user with ID: `abc123-def456-ghi789`
- Patient record created with `patient_id = abc123-def456-ghi789`
- **They are the SAME UUID**

---

## Where IDs Are Stored

### Supabase Auth
- **Location**: Supabase Dashboard → Authentication → Users
- **Field**: `id` (UUID)
- **Example**: `a1b2c3d4-e5f6-7890-abcd-ef1234567890`

### Patients Table
- **Location**: Supabase Dashboard → Table Editor → `patients`
- **Field**: `patient_id` (UUID) - **PRIMARY KEY**
- **Example**: `a1b2c3d4-e5f6-7890-abcd-ef1234567890` (same as Auth user ID)

---

## How Web App Uses the ID

### After Login
```javascript
// In Dashboard.tsx (line 28-30)
const { data } = await supabase.auth.getSession()
const id = data?.session?.user?.id  // Gets the UUID from the session
setPatientId(id)  // Uses it as patientId
```

**The web app automatically gets the patient ID from the logged-in session.**

---

## Mobile App Problem

### The Issue
The mobile app **doesn't have authentication**, so it can't:
- Get the user's Supabase Auth UUID
- Know which `patient_id` to use when sending health data

### Current Code
```kotlin
// In MainActivity.kt (line 50-53)
private fun currentPatientId(): String {
    val sp = getSharedPreferences("vitalink", android.content.Context.MODE_PRIVATE)
    return sp.getString("patientId", null) ?: ""  // Returns empty string!
}
```

**Result**: `patientId` is empty, so the app shows "login required" and can't send data.

---

## Solutions for Mobile App

### Option 1: Manual Entry (Temporary)
Add a Settings screen where user can manually enter their patient UUID (from web app registration).

### Option 2: QR Code / Link
Generate a QR code or link from web app that contains the patient UUID, mobile app scans/opens it.

### Option 3: Email Verification
User enters email on mobile app, receives a code, app gets patient UUID from server.

### Option 4: Re-add Authentication (Recommended)
Add Supabase Auth back to mobile app so it can:
- Register/login users
- Get the patient UUID from the session
- Automatically link health data to the correct patient

---

## Summary

✅ **Users DO have IDs** - They're UUIDs generated by Supabase Auth  
✅ **Patient records DO exist** - Created in `patients` table with `patient_id = Auth user ID`  
✅ **Web app works** - Gets ID from logged-in session  
❌ **Mobile app broken** - Can't get patient ID without authentication  

**Next Step**: Decide how mobile app should get the patient ID (manual entry, QR code, or re-add auth).

